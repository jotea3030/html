<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wingspan Bird Song Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display:flex; justify-content:center; align-items:center; padding:20px;
        }
        .game-container { max-width:1200px; width:100%; background:rgba(255,255,255,0.95); border-radius:20px; padding:40px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .header { text-align:center; margin-bottom:30px; }
        .header h1 { color:#2d3748; font-size:2.5em; margin-bottom:10px; }
        .header p { color:#718096; font-size:1.1em; }
        .loading-section { text-align:center; padding:40px; background:linear-gradient(135deg,#e6f7ff 0%,#bae7ff 100%); border-radius:15px; margin-bottom:30px; }
        .loading-spinner { border:4px solid #f3f4f6; border-top:4px solid #667eea; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .loading-text { color:#2d3748; font-size:1.1em; margin-bottom:10px; }
        .loading-detail { color:#718096; font-size:0.9em; }
        .game-stats { display:flex; justify-content:space-around; margin-bottom:30px; padding:20px; background:linear-gradient(135deg,#f6f8fb 0%,#e9ecef 100%); border-radius:15px; }
        .stat { text-align:center; }
        .stat-label { color:#718096; font-size:0.9em; margin-bottom:5px; }
        .stat-value { color:#2d3748; font-size:1.8em; font-weight:bold; }
        .audio-section { text-align:center; margin-bottom:40px; padding:30px; background:linear-gradient(135deg,#fff5e6 0%,#ffe8cc 100%); border-radius:15px; border:3px solid #ffa500; }
        .play-button { background: linear-gradient(135deg,#ffa500 0%,#ff8c00 100%); color:white; border:none; padding:20px 40px; font-size:1.2em; border-radius:50px; cursor:pointer; display:inline-flex; align-items:center; gap:10px; transition:transform 0.2s, box-shadow 0.2s; font-weight:bold; }
        .play-button:hover { transform:translateY(-2px); box-shadow:0 10px 25px rgba(255,165,0,0.4); }
        .play-button:active { transform:translateY(0); }
        .play-button:disabled { opacity:0.6; cursor:not-allowed; }
        .play-button.playing { background: linear-gradient(135deg,#48bb78 0%,#38a169 100%); }
        .attribution { font-size:0.75em; color:#718096; margin-top:10px; line-height:1.4; }
        .debug-log { margin-top:12px; font-family:monospace; font-size:12px; color:#2d3748; background:#f7fafc; border:1px dashed #cbd5e0; padding:10px; max-height:180px; overflow:auto; border-radius:8px; text-align:left; white-space:pre-wrap; }
        .bird-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
        .bird-card { background:white; border-radius:15px; padding:20px; cursor:pointer; transition:all 0.3s; border:3px solid transparent; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
        .bird-card:hover { transform:translateY(-5px); box-shadow:0 10px 20px rgba(0,0,0,0.2); }
        .bird-card.correct { border-color:#48bb78; background:linear-gradient(135deg,#f0fff4 0%,#c6f6d5 100%); animation:celebrate 0.5s; }
        .bird-card.incorrect { border-color:#f56565; background:linear-gradient(135deg,#fff5f5 0%,#fed7d7 100%); animation:shake 0.5s; }
        .bird-card.disabled { opacity:0.5; cursor:not-allowed; pointer-events:none; }
        @keyframes celebrate { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }
        .bird-name { font-size:1.2em; font-weight:bold; color:#2d3748; margin-bottom:8px; }
        .bird-scientific { font-size:0.9em; color:#718096; font-style:italic; margin-bottom:10px; }
        .bird-info { font-size:0.85em; color:#4a5568; line-height:1.5; }
        .result-message { text-align:center; padding:20px; border-radius:10px; margin-bottom:20px; font-size:1.2em; font-weight:bold; display:none; }
        .result-message.show { display:block; }
        .result-message.correct { background:linear-gradient(135deg,#c6f6d5 0%,#9ae6b4 100%); color:#22543d; }
        .result-message.incorrect { background:linear-gradient(135deg,#fed7d7 0%,#fc8181 100%); color:#742a2a; }
        .controls { display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }
        .btn { padding:12px 30px; border:none; border-radius:25px; font-size:1em; cursor:pointer; transition:all 0.3s; font-weight:bold; }
        .btn-primary { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,0.4); }
        .btn-secondary { background:linear-gradient(135deg,#e2e8f0 0%,#cbd5e0 100%); color:#2d3748; }
        .btn-secondary:hover { background:linear-gradient(135deg,#cbd5e0 0%,#a0aec0 100%); }
        .difficulty-selector { text-align:center; margin-bottom:30px; }
        .difficulty-selector label { display:block; margin-bottom:10px; color:#2d3748; font-weight:bold; }
        .difficulty-selector select { padding:10px 20px; border-radius:10px; border:2px solid #cbd5e0; font-size:1em; cursor:pointer; }
        .game-over { text-align:center; padding:40px; background:linear-gradient(135deg,#fef5e7 0%,#fadbd8 100%); border-radius:15px; margin-top:20px; }
        .game-over h2 { color:#2d3748; margin-bottom:20px; }
        .final-score { font-size:3em; color:#667eea; font-weight:bold; margin:20px 0; }
        .info-box { background:#e6f7ff; border-left:4px solid #1890ff; padding:15px; margin-bottom:20px; border-radius:5px; }
        .info-box p { color:#2d3748; margin:5px 0; font-size:0.9em; }
        .info-box a { color:#1890ff; text-decoration:none; }
        .info-box a:hover { text-decoration:underline; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ü¶Ö Wingspan Bird Song Game</h1>
            <p>Listen carefully and identify the bird by its song!</p>
        </div>

        <div id="loadingSection" class="loading-section">
            <div class="loading-spinner"></div>
            <div class="loading-text">Preparing bird songs...</div>
            <div class="loading-detail">Loading high-quality recordings</div>
        </div>

        <div id="gameContent" style="display: none;">
            <div class="info-box">
                <p><strong>üéµ About the recordings:</strong> This game uses curated bird songs from professional field recordings. Each recording includes attribution and links to the full collection.</p>
            </div>

            <div class="difficulty-selector">
                <label for="difficulty">Select Difficulty:</label>
                <select id="difficulty">
                    <option value="easy">Easy (4 birds)</option>
                    <option value="medium" selected>Medium (6 birds)</option>
                    <option value="hard">Hard (8 birds)</option>
                </select>
            </div>

            <div class="game-stats">
                <div class="stat">
                    <div class="stat-label">Round</div>
                    <div class="stat-value" id="round">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Score</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value" id="streak">0</div>
                </div>
            </div>

            <div class="audio-section">
                <p style="margin-bottom: 15px; color: #2d3748; font-size: 1.1em;">üéµ Listen to the bird song</p>
                <!-- Play button starts disabled to prevent early clicks before the first round is initialized -->
                <button class="play-button" id="playButton" disabled>
                    <span id="playIcon">‚ñ∂</span> <span id="playText">Play Bird Song</span>
                </button>
                <p style="margin-top: 15px; color: #718096; font-size: 0.9em;">Click to hear the mystery bird!</p>
                <div class="attribution" id="attribution"></div>
                <div id="debugLog" class="debug-log" aria-live="polite"></div>
            </div>

            <div class="result-message" id="resultMessage"></div>
            <div class="bird-grid" id="birdGrid"></div>

            <div class="controls">
                <button class="btn btn-secondary" id="replayButton" disabled>üîÑ Replay Song</button>
                <button class="btn btn-primary" id="nextButton" style="display: none;">Next Round ‚ûú</button>
            </div>

            <div id="gameOverSection" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Bird database (same as before)
        const allBirds = [
            { name: "American Robin", scientific: "Turdus migratorius", info: "Common songbird with cheerful, caroling song", audioUrl: "https://xeno-canto.org/sounds/uploaded/ZNCDXTUOFL/XC134898-LS100612%20Turdus%20migratorius.mp3", recordist: "Paul Driver", xcId: "134898" },
            { name: "Northern Cardinal", scientific: "Cardinalis cardinalis", info: "Bright red bird with loud, clear whistles", audioUrl: "https://xeno-canto.org/sounds/uploaded/GYAUIPBVZF/XC413729-NOCA.mp3", recordist: "Andrew Spencer", xcId: "413729" },
            { name: "Blue Jay", scientific: "Cyanocitta cristata", info: "Bold corvid with harsh, jay-jay calls", audioUrl: "https://xeno-canto.org/sounds/uploaded/OHGBMINRHW/XC51630-Blue%20Jay.mp3", recordist: "Greg Irving", xcId: "51630" },
            { name: "Black-capped Chickadee", scientific: "Poecile atricapillus", info: "Small bird with distinctive chick-a-dee-dee-dee", audioUrl: "https://xeno-canto.org/sounds/uploaded/VOLIQOYWKG/XC51188-Chickadee%2C%20Black-capped.mp3", recordist: "Paul Driver", xcId: "51188" },
            { name: "Song Sparrow", scientific: "Melospiza melodia", info: "Brown streaked sparrow with complex melodious song", audioUrl: "https://xeno-canto.org/sounds/uploaded/JVQVMCUUNY/XC420595-SOSP.mp3", recordist: "Andrew Spencer", xcId: "420595" },
            { name: "Wood Thrush", scientific: "Hylocichla mustelina", info: "Forest bird with flutelike, ethereal song", audioUrl: "https://xeno-canto.org/sounds/uploaded/RFGUXPZORH/XC413686-WOTH.mp3", recordist: "Andrew Spencer", xcId: "413686" },
            { name: "Eastern Meadowlark", scientific: "Sturnella magna", info: "Grassland bird with clear, whistled spring-of-the-year", audioUrl: "https://xeno-canto.org/sounds/uploaded/FQRXKOLNJB/XC83562-Meadowlark%2C%20Eastern.mp3", recordist: "Paul Driver", xcId: "83562" },
            { name: "Baltimore Oriole", scientific: "Icterus galbula", info: "Orange and black songbird with rich, whistling notes", audioUrl: "https://xeno-canto.org/sounds/uploaded/ZNSKRSHKBW/XC344942-baltimore_oriole_song.mp3", recordist: "Paul Marvin", xcId: "344942" },
            { name: "House Wren", scientific: "Troglodytes aedon", info: "Small brown bird with bubbling, cascading song", audioUrl: "https://xeno-canto.org/sounds/uploaded/TFOGORUSOL/XC413697-HOWR.mp3", recordist: "Andrew Spencer", xcId: "413697" },
            { name: "Red-winged Blackbird", scientific: "Agelaius phoeniceus", info: "Marsh bird with conk-la-ree call", audioUrl: "https://xeno-canto.org/sounds/uploaded/FWKBNDJBSP/XC420591-RWBL.mp3", recordist: "Andrew Spencer", xcId: "420591" },
            { name: "White-throated Sparrow", scientific: "Zonotrichia albicollis", info: "Sparrow with pure, whistled oh-sweet-canada song", audioUrl: "https://xeno-canto.org/sounds/uploaded/JVQVMCUUNY/XC420585-WTSP.mp3", recordist: "Andrew Spencer", xcId: "420585" },
            { name: "Common Yellowthroat", scientific: "Geothlypis trichas", info: "Warbler with witchity-witchity-witchity song", audioUrl: "https://xeno-canto.org/sounds/uploaded/OTVUCVOMMQ/XC420588-COYE.mp3", recordist: "Andrew Spencer", xcId: "420588" }
        ];

        // Game state
        let gameState = {
            round: 1, score: 0, streak: 0, maxRounds: 10,
            currentBird: null, roundBirds: [], answered: false, difficulty: 'medium',
            currentAudio: null, audioCache: {}, ready: false
        };

        // Debug logging helper
        function formatTime(d = new Date()) { return d.toISOString(); }
        function logDebug(message, obj) {
            const el = document.getElementById('debugLog');
            const time = formatTime();
            const text = `[${time}] ${message}` + (obj ? ` - ${String(obj)}` : '');
            console.log(text, obj);
            if (el) {
                let extra = '';
                if (obj instanceof Error) extra = '\n' + (obj.stack || obj.message);
                else if (obj && typeof obj === 'object') {
                    try { extra = '\n' + JSON.stringify(obj, null, 2); } catch (e) { extra = '\n[object]'; }
                }
                el.textContent = `${text}${extra}\n\n` + el.textContent;
            }
        }

        function mediaErrorMessage(err) {
            if (!err) return 'No MediaError';
            const code = err.code;
            switch (code) {
                case 1: return 'MEDIA_ERR_ABORTED (1): fetching aborted';
                case 2: return 'MEDIA_ERR_NETWORK (2): network error while downloading';
                case 3: return 'MEDIA_ERR_DECODE (3): decoding error';
                case 4: return 'MEDIA_ERR_SRC_NOT_SUPPORTED (4): audio not supported or cross-origin blocked';
                default: return `Unknown MediaError code: ${code}`;
            }
        }

        // Prepare audio URL with fetch->blob fallback and optional proxy fallback (logs everything)
        async function prepareAudioUrl(originalUrl) {
            logDebug('prepareAudioUrl: starting for ' + originalUrl);
            try {
                logDebug('prepareAudioUrl: trying direct fetch (cors) for', originalUrl);
                const resp = await fetch(originalUrl, { mode: 'cors' });
                logDebug('prepareAudioUrl: fetch response', { status: resp.status, type: resp.type, url: resp.url });
                if (resp.ok) {
                    const contentType = resp.headers.get('content-type') || '';
                    logDebug('prepareAudioUrl: content-type: ' + contentType);
                    const blob = await resp.blob();
                    const objUrl = URL.createObjectURL(blob);
                    logDebug('prepareAudioUrl: created objectURL from fetch', objUrl);
                    return { url: objUrl, source: 'fetch-blob' };
                } else {
                    logDebug(`prepareAudioUrl: fetch returned non-ok status ${resp.status}`);
                }
            } catch (err) {
                logDebug('prepareAudioUrl: fetch failed (CORS or network)', err);
            }

            // Proxy fallback (replace with your own proxy if you have one)
            const proxyPrefix = 'https://cors.bridged.cc/';
            try {
                const proxied = proxyPrefix + originalUrl;
                logDebug('prepareAudioUrl: attempting proxy fetch for', proxied);
                const resp2 = await fetch(proxied);
                logDebug('prepareAudioUrl: proxy fetch response', { status: resp2.status, type: resp2.type, url: resp2.url });
                if (resp2.ok) {
                    const blob2 = await resp2.blob();
                    const objUrl2 = URL.createObjectURL(blob2);
                    logDebug('prepareAudioUrl: created objectURL from proxy fetch', objUrl2);
                    return { url: objUrl2, source: 'proxy-blob' };
                } else {
                    logDebug('prepareAudioUrl: proxy fetch returned non-ok', { status: resp2.status, statusText: resp2.statusText });
                }
            } catch (err2) {
                logDebug('prepareAudioUrl: proxy fetch failed', err2);
            }

            logDebug('prepareAudioUrl: falling back to original URL (may be blocked)', originalUrl);
            return { url: originalUrl, source: 'original' };
        }

        // Create Audio element and attach logging listeners
        function createAudioElement(url) {
            const audio = new Audio();
            audio.preload = 'auto';
            audio.src = url;
            audio.crossOrigin = "anonymous"; // try to help decoding where possible

            audio.addEventListener('error', (ev) => {
                const e = ev?.target?.error;
                const msg = mediaErrorMessage(e);
                logDebug(`audio.error event for src=${audio.src}: ${msg}`, e || ev);
            });
            audio.addEventListener('loadeddata', () => logDebug(`loadeddata for src=${audio.src}, readyState=${audio.readyState}, networkState=${audio.networkState}`));
            audio.addEventListener('canplaythrough', () => logDebug(`canplaythrough for src=${audio.src}, readyState=${audio.readyState}, networkState=${audio.networkState}`));
            audio.addEventListener('stalled', () => logDebug(`stalled event for src=${audio.src}`));
            audio.addEventListener('suspend', () => logDebug(`suspend event for src=${audio.src}`));
            audio.addEventListener('waiting', () => logDebug(`waiting event for src=${audio.src}`));

            return audio;
        }

        // Preload audio (non-blocking if individual files fail)
        async function preloadAudio() {
            const loadingSection = document.getElementById('loadingSection');
            const loadingDetail = loadingSection.querySelector('.loading-detail');

            let loaded = 0;
            const total = allBirds.length;
            logDebug('preloadAudio: starting preload for ' + total + ' birds');

            for (const bird of allBirds) {
                try {
                    loadingDetail.textContent = `Loading ${bird.name} (${loaded + 1}/${total})...`;
                    logDebug('preloadAudio: preparing ' + bird.name + ' -> ' + bird.audioUrl);

                    const prepared = await prepareAudioUrl(bird.audioUrl);
                    logDebug('preloadAudio: prepared URL', prepared);

                    const audioElement = createAudioElement(prepared.url);

                    await new Promise((resolve, reject) => {
                        let settled = false;
                        const onSuccess = () => { if (settled) return; settled = true; cleanup(); resolve(); };
                        const onError = (ev) => { if (settled) return; settled = true; cleanup(); reject(ev || new Error('audio error')); };
                        const cleanup = () => {
                            audioElement.removeEventListener('canplaythrough', onSuccess);
                            audioElement.removeEventListener('loadeddata', onSuccess);
                            audioElement.removeEventListener('error', onError);
                        };
                        audioElement.addEventListener('canplaythrough', onSuccess, { once: true });
                        audioElement.addEventListener('loadeddata', onSuccess, { once: true });
                        audioElement.addEventListener('error', onError, { once: true });
                        try { audioElement.load(); } catch (e) { logDebug('audio.load() threw in preload', e); }
                        setTimeout(() => {
                            if (settled) return;
                            logDebug('preloadAudio: timeout waiting for loadeddata/canplaythrough for ' + bird.name + ', continuing (on-demand may still work).');
                            settled = true;
                            cleanup();
                            resolve();
                        }, 5000);
                    });

                    gameState.audioCache[bird.name] = audioElement;
                    logDebug('preloadAudio: cached audio for ' + bird.name + ' (src=' + audioElement.src + ')');
                } catch (err) {
                    logDebug('preloadAudio: could not preload audio for ' + bird.name, err);
                } finally {
                    loaded++;
                }
            }

            loadingSection.style.display = 'none';
            document.getElementById('gameContent').style.display = 'block';
            logDebug('preloadAudio: complete, showing game UI. Calling initGame() next.');
            initGame();
        }

        // Initialize game and start first round
        function initGame() {
            logDebug('initGame: called');
            gameState.difficulty = document.getElementById('difficulty').value;
            gameState.round = 1;
            gameState.score = 0;
            gameState.streak = 0;
            document.getElementById('gameOverSection').style.display = 'none';
            startNewRound();
            gameState.ready = true;
            logDebug('initGame: finished (ready=true)', { round: gameState.round, difficulty: gameState.difficulty, currentBird: gameState.currentBird ? gameState.currentBird.name : null });
        }

        // Start a new round, set currentBird, enable play/replay buttons
        function startNewRound() {
            gameState.answered = false;

            if (gameState.currentAudio) {
                try { gameState.currentAudio.pause(); gameState.currentAudio.currentTime = 0; } catch (e) { logDebug('Error stopping current audio', e); }
            }

            const playButton = document.getElementById('playButton');
            playButton.classList.remove('playing');
            document.getElementById('playIcon').textContent = '‚ñ∂';
            document.getElementById('playText').textContent = 'Play Bird Song';

            const numBirds = gameState.difficulty === 'easy' ? 4 : gameState.difficulty === 'medium' ? 6 : 8;
            const shuffled = [...allBirds].sort(() => Math.random() - 0.5);
            gameState.roundBirds = shuffled.slice(0, numBirds);
            gameState.currentBird = gameState.roundBirds[Math.floor(Math.random() * numBirds)];

            if (!gameState.currentBird) {
                logDebug('startNewRound: WARNING - currentBird is null after selection. Forcing selection fallback.');
                // Fallback: pick first bird
                gameState.currentBird = allBirds[0];
            }

            logDebug('startNewRound: started new round', { round: gameState.round, currentBird: gameState.currentBird.name });

            updateStats();
            renderBirdCards();
            document.getElementById('resultMessage').classList.remove('show');
            document.getElementById('nextButton').style.display = 'none';

            // Enable play/replay now that a bird is selected for the round
            document.getElementById('playButton').disabled = false;
            document.getElementById('replayButton').disabled = false;
            document.getElementById('attribution').innerHTML = '';
            // Clear debug panel for fresh round logs (useful during interactive testing)
            // but keep a trace of prior events above in the console
            document.getElementById('debugLog').textContent = '';
        }

        // Update game stats in UI
        function updateStats() {
            document.getElementById('round').textContent = gameState.round;
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('streak').textContent = gameState.streak;
        }

        // Render bird choice cards
        function renderBirdCards() {
            const grid = document.getElementById('birdGrid');
            grid.innerHTML = '';
            gameState.roundBirds.forEach(bird => {
                const card = document.createElement('div');
                card.className = 'bird-card';
                card.innerHTML = `<div class="bird-name">${bird.name}</div><div class="bird-scientific">${bird.scientific}</div><div class="bird-info">${bird.info}</div>`;
                card.onclick = () => selectBird(bird, card);
                grid.appendChild(card);
            });
        }

        // Handle bird selection by the user
        function selectBird(bird, cardElement) {
            if (gameState.answered) return;
            gameState.answered = true;
            const isCorrect = bird === gameState.currentBird;

            if (gameState.currentAudio) {
                try { gameState.currentAudio.pause(); } catch (e) { logDebug('Error pausing audio on selection', e); }
            }

            const playButton = document.getElementById('playButton');
            playButton.classList.remove('playing');
            document.getElementById('playIcon').textContent = '‚ñ∂';
            document.getElementById('playText').textContent = 'Play Bird Song';

            document.querySelectorAll('.bird-card').forEach(c => c.classList.add('disabled'));
            cardElement.classList.remove('disabled');
            cardElement.classList.add(isCorrect ? 'correct' : 'incorrect');

            if (!isCorrect) {
                document.querySelectorAll('.bird-card').forEach(c => {
                    const birdName = c.querySelector('.bird-name').textContent;
                    if (birdName === gameState.currentBird.name) {
                        c.classList.remove('disabled');
                        c.classList.add('correct');
                    }
                });
            }

            const resultMsg = document.getElementById('resultMessage');
            if (isCorrect) {
                gameState.score += 10 + (gameState.streak * 2);
                gameState.streak++;
                resultMsg.textContent = `üéâ Correct! That was a ${bird.name}! +${10 + ((gameState.streak - 1) * 2)} points`;
                resultMsg.className = 'result-message show correct';
            } else {
                gameState.streak = 0;
                resultMsg.textContent = `‚ùå Not quite. That was a ${gameState.currentBird.name}.`;
                resultMsg.className = 'result-message show incorrect';
            }

            logDebug('selectBird: selection made', { selected: bird.name, correct: isCorrect, target: gameState.currentBird.name });
            updateStats();

            if (gameState.round >= gameState.maxRounds) setTimeout(endGame, 2000);
            else document.getElementById('nextButton').style.display = 'inline-block';

            document.getElementById('playButton').disabled = true;
            document.getElementById('replayButton').disabled = true;
        }

        // End game display
        function endGame() {
            const gameOverSection = document.getElementById('gameOverSection');
            const accuracy = Math.round((gameState.score / (gameState.maxRounds * 10)) * 100);
            gameOverSection.innerHTML = `
                <div class="game-over">
                    <h2>üèÜ Game Complete!</h2>
                    <div class="final-score">${gameState.score}</div>
                    <p style="font-size: 1.2em; color: #2d3748; margin-bottom: 20px;">
                        You identified birds with ${accuracy}% accuracy!
                    </p>
                    <p style="font-size: 0.9em; color: #718096; margin-bottom: 20px;">
                        Recordings courtesy of <a href="https://xeno-canto.org" target="_blank">Xeno-canto.org</a>
                    </p>
                    <button class="btn btn-primary" onclick="initGame()">üîÑ Play Again</button>
                </div>
            `;
            gameOverSection.style.display = 'block';
            logDebug('endGame: game ended', { score: gameState.score, accuracy });
        }

        // Play bird song (toggle). This is async because we may prepare audio on-demand.
        async function playBirdSong() {
            const playButton = document.getElementById('playButton');
            const playIcon = document.getElementById('playIcon');
            const playText = document.getElementById('playText');

            logDebug('playBirdSong called', { currentBird: gameState.currentBird ? gameState.currentBird.name : null });

            // If user clicked very early and no bird is selected, attempt to recover by initializing a round
            if (!gameState.currentBird) {
                logDebug('playBirdSong: No current bird selected - forcing startNewRound to recover.');
                // try to initialize a round synchronously and allow UI to enable; if preloads exist, startNewRound picks one
                startNewRound();
                // brief pause to allow startNewRound to enable controls / set currentBird
                await new Promise(r => setTimeout(r, 50));
            }

            if (gameState.currentAudio && !gameState.currentAudio.paused) {
                try { gameState.currentAudio.pause(); gameState.currentAudio.currentTime = 0; logDebug('playBirdSong: paused current audio'); } catch (e) { logDebug('playBirdSong: error pausing', e); }
                playButton.classList.remove('playing');
                playIcon.textContent = '‚ñ∂';
                playText.textContent = 'Play Bird Song';
                return;
            }

            if (!gameState.currentBird) {
                logDebug('playBirdSong: still no currentBird after recovery attempt; aborting play. User should wait until initialization completes.');
                document.getElementById('attribution').textContent = 'Game initializing; please wait a moment and try Play again.';
                return;
            }

            // Prepare or get cached audio
            let audio = gameState.audioCache[gameState.currentBird.name];
            logDebug('playBirdSong: audio cache lookup', { bird: gameState.currentBird.name, cached: !!audio });

            if (!audio) {
                // Try to prepare a playable url (fetch->blob or proxy) and create audio element
                try {
                    const prepared = await prepareAudioUrl(gameState.currentBird.audioUrl);
                    logDebug('playBirdSong: prepared URL on-demand', prepared);
                    audio = createAudioElement(prepared.url);
                    gameState.audioCache[gameState.currentBird.name] = audio;
                } catch (err) {
                    logDebug('playBirdSong: prepareAudioUrl failed on-demand', err);
                }
            }

            if (!audio) {
                // Last resort: try original URL directly
                logDebug('playBirdSong: creating audio element using original URL as last resort', gameState.currentBird.audioUrl);
                audio = createAudioElement(gameState.currentBird.audioUrl);
                gameState.audioCache[gameState.currentBird.name] = audio;
            }

            gameState.currentAudio = audio;
            try { audio.currentTime = 0; } catch (e) { logDebug('playBirdSong: setting currentTime failed', e); }

            logDebug('Attempting audio.play()', { src: audio.src, readyState: audio.readyState, networkState: audio.networkState });

            try {
                const playResult = audio.play();
                if (playResult && typeof playResult.then === 'function') {
                    playResult.then(() => {
                        logDebug('Playback started successfully');
                        playButton.classList.add('playing');
                        playIcon.textContent = '‚è∏';
                        playText.textContent = 'Pause';
                    }).catch((err) => {
                        logDebug('Playback promise rejected', err);
                        document.getElementById('attribution').textContent = 'Playback failed. See debug log for details.';
                        alert('Playback failed. The browser may have blocked autoplay or the audio failed to load. Check the debug log (panel) for details.');
                    });
                } else {
                    // older browsers may not return a promise
                    playButton.classList.add('playing');
                    playIcon.textContent = '‚è∏';
                    playText.textContent = 'Pause';
                    logDebug('audio.play() did not return a promise; assuming started');
                }
            } catch (err) {
                logDebug('audio.play() threw an exception', err);
                document.getElementById('attribution').textContent = 'Playback exception. See debug log for details.';
                alert('Playback failed. The browser may have blocked autoplay or the audio failed to load. See the debug log for details.');
            }

            const bird = gameState.currentBird;
            document.getElementById('attribution').innerHTML = `Recording by ${bird.recordist} | <a href="https://xeno-canto.org/${bird.xcId}" target="_blank">View on Xeno-canto (XC${bird.xcId})</a>`;

            audio.onended = () => {
                logDebug('audio ended event for src=' + audio.src);
                playButton.classList.remove('playing');
                playIcon.textContent = '‚ñ∂';
                playText.textContent = 'Play Bird Song';
            };
        }

        // Event listeners
        document.getElementById('playButton').addEventListener('click', playBirdSong);
        document.getElementById('replayButton').addEventListener('click', playBirdSong);

        document.getElementById('nextButton').addEventListener('click', () => {
            gameState.round++;
            startNewRound();
        });

        document.getElementById('difficulty').addEventListener('change', () => {
            if (confirm('Changing difficulty will restart the game. Continue?')) initGame();
        });

        // Kick off preload
        logDebug('Page load: starting audio preload');
        preloadAudio();
    </script>
</body>
</html>
